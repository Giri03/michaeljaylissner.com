<!DOCTYPE html>
<html lang="en-US">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="author" content="Mike Lissner" />
        <meta name="copyright" content="Mike Lissner" />

        <link rel="author" href=https://plus.google.com/+MikeLissner />
        <meta name="twitter:creator" content="@mlissner">
        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content="sqlite3, f-spot, database, bash, Tech, " />

<meta property="og:title" content="Script to Clean Up F-Spot Database "/>
<meta property="og:url" content="//localhost:8000/posts/2009/10/14/script-to-cleanup-fspot-database/" />
<meta property="og:description" content="One of the more popular photo management applications for Linux is f-spot, but unfortunately it has a rather glaring bug. It uses a sqlite3 database internally to track which pictures you’ve imported into it, what tags they have, etc. However, if you delete, move or rename any of the ..." />
<meta property="og:site_name" content="Michael Jay Lissner" />
<meta property="og:article:author" content="Mike Lissner" />
<meta property="og:article:published_time" content="2009-10-14T00:30:12" />
<meta name="twitter:title" content="Script to Clean Up F-Spot Database ">
<meta name="twitter:description" content="One of the more popular photo management applications for Linux is f-spot, but unfortunately it has a rather glaring bug. It uses a sqlite3 database internally to track which pictures you’ve imported into it, what tags they have, etc. However, if you delete, move or rename any of the ...">
<meta property="og:image" content="//localhost:8000/theme/images/apple-touch-icon-152x152.png" />
<meta name="twitter:image" content="//localhost:8000/theme/images/apple-touch-icon-152x152.png" >

        <title>Script to Clean Up F-Spot Database  · Michael Jay Lissner
</title>
        <link href="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/css/bootstrap-combined.min.css" rel="stylesheet">
        <link href="//netdna.bootstrapcdn.com/font-awesome/4.0.1/css/font-awesome.css" rel="stylesheet">
        <link rel="stylesheet" type="text/css" href="//localhost:8000/theme/css/pygments.css" media="screen">
        <link rel="stylesheet" type="text/css" href="//localhost:8000/theme/tipuesearch/tipuesearch.css" media="screen">
        <link rel="stylesheet" type="text/css" href="//localhost:8000/theme/css/elegant.css" media="screen">
        <link rel="stylesheet" type="text/css" href="//localhost:8000/theme/css/custom.css" media="screen">
        <link rel="shortcut icon" href="//localhost:8000/theme/images/favicon.ico" type="image/x-icon" type="image/png" />
        <link rel="icon" href="//localhost:8000/theme/images/apple-touch-icon-152x152.png" type="image/png" />
        <link rel="apple-touch-icon" href="//localhost:8000/theme/images/apple-touch-icon.png"  type="image/png" />
        <link rel="apple-touch-icon" sizes="57x57" href="//localhost:8000/theme/images/apple-touch-icon-57x57.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="72x72" href="//localhost:8000/theme/images/apple-touch-icon-72x72.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="76x76" href="//localhost:8000/theme/images/apple-touch-icon-76x76.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="114x114" href="//localhost:8000/theme/images/apple-touch-icon-114x114.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="120x120" href="//localhost:8000/theme/images/apple-touch-icon-120x120.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="144x144" href="//localhost:8000/theme/images/apple-touch-icon-144x144.png" type="image/png" />
        <link rel="apple-touch-icon" sizes="152x152" href="//localhost:8000/theme/images/apple-touch-icon-152x152.png" type="image/png" />
    </head>
    <body>
        <div id="content-sans-footer">
        <div class="navbar navbar-static-top">
            <div class="navbar-inner">
                <div class="container-fluid">
                    <div class="span1"></div>
                    <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </a>
                    <a class="brand" href="//localhost:8000/"><span class=site-name>Michael Jay Lissner</span></a>
                    <div class="nav-collapse collapse">
                        <ul class="nav pull-right top-menu">
                            <li ><a href="//localhost:8000">Home</a></li>
                                        <li ><a href="//localhost:8000/about">About&nbsp;Site</a></li>
                                        <li ><a href="//localhost:8000/contact">Contact</a></li>
                                        <li ><a href="//localhost:8000/projects-and-papers">Projects <span class="amp">&amp;</span>&nbsp;Papers</a></li>
                            <li ><a href="//localhost:8000/tags.html">Tags</a></li>
                            <li ><a href="//localhost:8000/archives.html">Archives</a></li>
                            <li><form class="navbar-search" action="//localhost:8000/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        <div class="container-fluid">
            <div class="row-fluid">
                <div class="span1"></div>
                <div class="span10">
<article>
<div class="row-fluid">
    <header class="page-header span10 offset2">
    <h1><a href="//localhost:8000/posts/2009/10/14/script-to-cleanup-fspot-database/"> Script to Clean Up F-Spot&nbsp;Database  </a></h1>
    </header>
</div>

<div class="row-fluid">
        <div class="span8 offset2 article-content">

            
            <p>One of the more popular photo management applications for Linux is f-spot, 
but unfortunately it has a rather glaring bug. It uses a sqlite3 database 
internally to track which pictures you&#8217;ve imported into it, 
what tags they have, etc. However, if you delete, move or rename any of the
files that f-spot is tracking, the next time you browse to that photo within f-spot, it will crash the program. It&#8217;s annoying, and there&#8217;s no particularly easy way to deal with it&#8230;until&nbsp;now.</p>
<p>The script below simply iterates through all of the photos 
that are in f-spot&#8217;s database, and checks to see if those photos exist on 
your hard drive. If you run it in demo-mode, it will show you which files 
look problematic, and if you run it in normal mode, 
it will delete those database entries so that your database is cleaned up 
(but not before backing up your database, just in&nbsp;case).</p>
<p>In my very limited testing, it works very well, any additional feedback or 
bug reporting is more than&nbsp;welcome. </p>
<div class="highlight"><pre><span class="c">#!/bin/bash</span>

<span class="c"># A script to find missing files in the f-spot database, and then delete them.</span>
<span class="c"># At present these files crash f-spot. It&#39;s frustrating as all hell.</span>

<span class="nb">echo</span> <span class="s2">&quot;Welcome to the f-spot database cleaner. All the usual disclaimers apply, as you might imagine.&quot;</span>
<span class="nb">echo</span> <span class="s2">&quot;What would you like to do: &quot;</span> 
<span class="nb">echo</span> <span class="s2">&quot;  1) Run in demo-mode &quot;</span> 
<span class="nb">echo</span> <span class="s2">&quot;  2) Clean up your f-spot database&quot;</span> 
<span class="nb">echo</span> <span class="s2">&quot;  3) Quit&quot;</span> 
<span class="nb">read</span> -p <span class="s2">&quot;Your choice: &quot;</span> choice

<span class="k">case</span> <span class="nv">$choice</span> in 
    1<span class="o">)</span> <span class="nv">demomode</span><span class="o">=</span><span class="s2">&quot;true&quot;</span>;;
    2<span class="o">)</span> <span class="nv">demomode</span><span class="o">=</span><span class="s2">&quot;false&quot;</span>;;
    3<span class="o">)</span> <span class="nb">exit </span>0;;
<span class="k">esac</span>

<span class="c"># With that beginning stuff out of the way, let us do some functions</span>
<span class="c"># First, a function to gather the database contents and to print out the ones that are orphans</span>

<span class="k">function </span>findAndFixOrphans <span class="o">{</span>
    <span class="c"># find our db, and set a var. Checking for XDG path first, since it&#39;s the more recent location of the db</span>
    <span class="k">if</span> <span class="o">[</span> -f <span class="nv">$XDG_CONFIG_DIR</span>/f-spot/photos.db <span class="o">]</span> <span class="c">#checks if the $XDG_CONFIG_DIR variable is in use</span>
    <span class="k">then</span>
<span class="k">        </span><span class="nv">DBPATH</span><span class="o">=</span><span class="nv">$XDG_CONFIG_DIR</span>/f-spot/photos.db
    <span class="k">elif</span> <span class="o">[</span> -f <span class="nv">$HOME</span>/.config/f-spot/photos.db <span class="o">]</span> <span class="c">#uses the default $XDG location, if that&#39;s being used.</span>
    <span class="k">then</span>
<span class="k">        </span><span class="nv">DBPATH</span><span class="o">=</span><span class="nv">$HOME</span>/.config/f-spot/photos.db
    <span class="k">elif</span> <span class="o">[</span> -f <span class="nv">$HOME</span>/.gnome2/f-spot/photos.db <span class="o">]</span> <span class="c">#uses the old location of the DB, if the former aren&#39;t in use.</span>
    <span class="k">then</span>
<span class="k">        </span><span class="nv">DBPATH</span><span class="o">=</span><span class="nv">$HOME</span>/.gnome2/f-spot/photos.db
    <span class="k">else</span>
<span class="k">        </span><span class="nb">echo</span> <span class="s2">&quot;Error: Could not find database. Damn.&quot;</span> 
        <span class="nb">exit </span>1
    <span class="k">fi</span>

    <span class="c"># Select the filenames, and put them in a variable.</span>
    <span class="nv">filenames</span><span class="o">=</span><span class="k">$(</span>sqlite3 <span class="nv">$DBPATH</span> <span class="s2">&quot;SELECT URI FROM PHOTOS&quot;</span><span class="k">)</span>
    <span class="nv">filenames_versions</span><span class="o">=</span><span class="k">$(</span>sqlite3 <span class="nv">$DBPATH</span> <span class="s2">&quot;SELECT URI FROM PHOTO_VERSIONS&quot;</span><span class="k">)</span>

    <span class="c"># Chomp off the first instance of file://, and replace the rest with newlines.</span>
    <span class="nv">filenames</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$filenames</span> | sed <span class="s1">&#39;s/file:\/\///&#39;</span> | sed <span class="s1">&#39;s/file:\/\//\n/g&#39;</span>  <span class="k">)</span>
    <span class="nv">filenames_versions</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="nv">$filenames_versions</span> | sed <span class="s1">&#39;s/file:\/\///&#39;</span> | sed <span class="s1">&#39;s/file:\/\//\n/g&#39;</span> <span class="k">)</span>

    <span class="k">if</span> <span class="o">[</span> <span class="nv">$demomode</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span> <span class="o">]</span>
    <span class="k">then            </span>
<span class="k">        while </span><span class="nb">read</span> -r line
        <span class="k">do</span>
            <span class="c"># Decode the filename</span>
            <span class="nv">decodedLine</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> -e <span class="s2">&quot;${line//\%/\\x}&quot;</span><span class="k">)</span>
            <span class="k">if</span> <span class="o">[</span> ! -f  <span class="s2">&quot;$decodedLine&quot;</span> <span class="o">]</span> 
            <span class="k">then</span>
                <span class="c"># If the file doesn&#39;t exist, we output the filename, if in demomode, or we fix it if we are not in demomode.</span>
                <span class="nb">echo</span>  <span class="s2">&quot;Errant record found in the photos table: $decodedLine&quot;</span>
            <span class="k">fi</span>
<span class="k">        done</span> <span class="o">&lt;&lt;&lt;</span> <span class="s2">&quot;$filenames&quot;</span>

        <span class="c"># We do the same for the photo_versions table</span>
        <span class="k">while </span><span class="nb">read</span> -r line
        <span class="k">do</span>
            <span class="c"># Decode filename</span>
            <span class="nv">decodedLine</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> -e <span class="s2">&quot;${line//\%/\\x}&quot;</span><span class="k">)</span>
            <span class="k">if</span> <span class="o">[</span> ! -f <span class="s2">&quot;$decodedLine&quot;</span> <span class="o">]</span>
            <span class="k">then</span>
                <span class="c"># If the file doesn&#39;t exist, we output the filename</span>
                <span class="nb">echo</span> <span class="s2">&quot;Errant record found in the photo_versions table: $decodedLine&quot;</span>
            <span class="k">fi</span>
<span class="k">        done</span> <span class="o">&lt;&lt;&lt;</span> <span class="s2">&quot;$filenames_versions&quot;</span>

    <span class="k">else</span>
        <span class="c"># We backup the database, and make the correction</span>
        cp <span class="nv">$DBPATH</span> <span class="nv">$DBPATH</span>.<span class="sb">`</span>date -I<span class="sb">`</span>.bak
        <span class="k">if</span> <span class="o">[</span> <span class="nv">$?</span> -eq 0 <span class="o">]</span>
        <span class="k">then</span>
            <span class="c">#The backup worked, tell the user.</span>
            <span class="nb">echo</span> <span class="s2">&quot;Your database has been backed up to $DBPATH.`date -I`.bak&quot;</span>
        <span class="k">else</span>
<span class="k">            </span><span class="nb">echo</span> <span class="s2">&quot;Error backing up your database.&quot;</span>
            <span class="nb">exit </span>3
        <span class="k">fi</span>

        <span class="c"># First we do the photos table</span>
        <span class="k">while </span><span class="nb">read</span> -r line
        <span class="k">do</span>
            <span class="c"># Decode the filename</span>
            <span class="nv">decodedLine</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> -e <span class="s2">&quot;${line//\%/\\x}&quot;</span><span class="k">)</span>

            <span class="k">if</span> <span class="o">[</span> ! -f <span class="s2">&quot;$decodedLine&quot;</span> <span class="o">]</span>
            <span class="k">then</span>
                <span class="c"># Do some sql here.</span>
                <span class="nv">foo</span><span class="o">=</span><span class="s2">&quot;file://${line}&quot;</span>
                <span class="nb">echo</span> -n <span class="s2">&quot;Deleting URI $line from the database table photos...&quot;</span>
                sqlite3 <span class="nv">$DBPATH</span> <span class="s2">&quot;DELETE FROM PHOTOS WHERE uri = &#39;$foo&#39;&quot;</span>
                <span class="nb">echo</span> <span class="s2">&quot;done.&quot;</span>
            <span class="k">fi</span>
<span class="k">        done</span> <span class="o">&lt;&lt;&lt;</span> <span class="s2">&quot;$filenames&quot;</span>

        <span class="c"># Then we do the photo_versions table</span>
        <span class="k">while </span><span class="nb">read</span> -r line
        <span class="k">do</span>
            <span class="c"># Decode the filename</span>
            <span class="nv">decodedLine</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> -e <span class="s2">&quot;${line//\%/\\x}&quot;</span><span class="k">)</span>

            <span class="k">if</span> <span class="o">[</span> ! -f <span class="s2">&quot;$decodedLine&quot;</span> <span class="o">]</span>
            <span class="k">then</span>
                <span class="c">#Do some sql stuff</span>
                <span class="nv">foo</span><span class="o">=</span><span class="s2">&quot;file://${line}&quot;</span>
                <span class="nb">echo</span> -n <span class="s2">&quot;Deleting URI $line from the database table photo_versions...&quot;</span>
                sqlite3 <span class="nv">$DBPATH</span> <span class="s2">&quot;DELETE FROM PHOTO_VERSIONS WHERE uri = &#39;$foo&#39;&quot;</span>
                <span class="nb">echo</span> <span class="s2">&quot;done.&quot;</span>
            <span class="k">fi</span>
<span class="k">        done</span> <span class="o">&lt;&lt;&lt;</span> <span class="s2">&quot;$filenames_versions&quot;</span>

    <span class="k">fi</span>

<span class="o">}</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$demomode&quot;</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span> <span class="o">]</span>
<span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;Great. Proceeding in demomode.&quot;</span>

    findAndFixOrphans

    <span class="nb">echo</span> <span class="s2">&quot;Demomode successfully finished. Exiting.&quot;</span>
    <span class="nb">exit </span>0;
<span class="k">elif</span> <span class="o">[</span> <span class="s2">&quot;$demomode&quot;</span> <span class="o">==</span> <span class="s2">&quot;false&quot;</span> <span class="o">]</span>
<span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;Great. Cleaning up your database.&quot;</span>

    findAndFixOrphans

    <span class="nb">echo</span> <span class="s2">&quot;Database cleaned successfully.&quot;</span>
    <span class="nb">exit </span>0;
<span class="k">else</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;Something strange happened. See the script for details. Exiting.&quot;</span>
    <span class="nb">exit </span>2;
<span class="k">fi</span>
</pre></div>
            
            
            <hr/>
            <aside>
            <nav>
            <ul class="articles-timeline">
                <li class="previous-article">« <a href="//localhost:8000/posts/2009/10/09/de-dup-thunderbird-address-book-contacts/" title="Previous: Fix Duplicate Thunderbird Address Book Contacts">Fix Duplicate Thunderbird Address Book Contacts</a></li>
                <li class="next-article"><a href="//localhost:8000/posts/2009/10/28/rid-thyself-of-autocomplete-in-firefox/" title="Next: Rid Thyself of Autocomplete=Off in Firefox">Rid Thyself of Autocomplete=Off in Firefox</a> »</li>
            </ul>
            </nav>
            </aside>
        </div>
        <section>
        <div class="span2" style="float:right;font-size:0.9em;">
            <h4>Published</h4>
            <time pubdate="pubdate" datetime="2009-10-14T00:30:12">Oct 14, 2009</time>
            <h4>Category</h4>
            <a class="category-link" href="//localhost:8000/categories.html#tech-ref">Tech</a>
            <h4>Tags</h4>
            <ul class="list-of-tags tags-in-article">
                <li><a href="//localhost:8000/tags.html#bash-ref">bash
                    <span>3</span>
</a></li>
                <li><a href="//localhost:8000/tags.html#database-ref">database
                    <span>3</span>
</a></li>
                <li><a href="//localhost:8000/tags.html#f-spot-ref">f-spot
                    <span>2</span>
</a></li>
                <li><a href="//localhost:8000/tags.html#sqlite3-ref">sqlite3
                    <span>1</span>
</a></li>
            </ul>
<h4>Contact</h4>
    <a href="http://twitter.com/mlissner" title="My Twitter Profile" class="sidebar-social-links" target="_blank">
    <i class="fa fa-twitter sidebar-social-links"></i></a>
    <a href="http://github.com/mlissner" title="My Github Profile" class="sidebar-social-links" target="_blank">
    <i class="fa fa-github sidebar-social-links"></i></a>
    <a href="mailto:mlissner+blog@michaeljaylissner.com" title="My Email Address" class="sidebar-social-links" target="_blank">
    <i class="fa fa-envelope sidebar-social-links"></i></a>
<h4>This is Reader-Editable</h4>
<a href="https://github.com/mlissner/michaeljaylissner.com/edit/master/content/script-to-cleanup-fspot-database.md">
    <i class="fa fa-github"></i>
    Edit this post on Github
</a><!-- Begin MailChimp Signup Form -->
<div id="mc-embed-signup">
<form action="//asdf.us2.list-manage.com/subscribe/post?u=87204b44efb46f0fd27b95167&amp;id=f511375e11" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
<h4>Get Weekly Updates</h4>
<input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="Enter your email..." required>
<div class="clear"><input type="submit" value="Send Me Updates" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
</form>
</div>
<!--End mc_embed_signup-->
        </div>
        </section>
</div>
</article>
                </div>
                <div class="span1"></div>
            </div>
        </div>
        <div id="push"></div>
    </div>
<footer>
<div id="footer">
    <ul class="footer-content">
        <li class="elegant-license">Unless mentioned otherwise, all material on this site is <a href="about#license">licensed</a> under a Creative Commons copyright or the GNU Affero GPL. <a href="about#privacy">Privacy Policy</a>.</li>
        <li class="elegant-power">Powered by <a href="http://getpelican.com/" title="Pelican Home Page">Pelican</a>. Theme: <a href="http://oncrashreboot.com/pelican-elegant" title="Theme Elegant Home Page">Elegant</a> by <a href="http://oncrashreboot.com" title="Talha Mansoor Home Page">Talha Mansoor</a></li>
    </ul>
</div>
</footer>            <script src="//code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    
    </body>
    <!-- Theme: Elegant built for Pelican
    License : http://oncrashreboot.com/pelican-elegant -->
</html>